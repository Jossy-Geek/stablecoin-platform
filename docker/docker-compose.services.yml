version: '3.8'

# Application Services
# This file contains all application services: backend services and frontends
# Usage: docker-compose -f docker/docker-compose.services.yml up -d
# Note: Infrastructure services must be running first

networks:
  stablecoin-network:
    external: true

services:
  # ============================================
  # Backend Services
  # ============================================

  user-service:
    build:
      context: ../services/user-service
      dockerfile: Dockerfile
    container_name: user-service
    ports:
      - "${USER_SERVICE_PORT:-3001}:3001"
    env_file:
      - .env
      - ../services/user-service/.env
    environment:
      # Use IP if provided, otherwise use container name
      DATABASE_HOST: ${DATABASE_HOST_IP:-postgres-user}
      REDIS_HOST: ${REDIS_HOST_IP:-redis}
      KAFKA_BROKER: ${KAFKA_BROKER_IP:-kafka:9092}
      RABBITMQ_URL: ${RABBITMQ_URL_IP:-amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASSWORD:-guest}@rabbitmq:5672}
      NODE_ENV: production
    depends_on:
      postgres-user:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - stablecoin-network
    restart: unless-stopped

  transaction-service:
    build:
      context: ../services/transaction-fireblocks-service
      dockerfile: Dockerfile
    container_name: transaction-service
    ports:
      - "${TRANSACTION_SERVICE_PORT:-3003}:3003"
    env_file:
      - .env
      - ../services/transaction-fireblocks-service/.env
    environment:
      # Use IP if provided, otherwise use container name
      DATABASE_HOST: ${DATABASE_HOST_IP:-postgres-transaction}
      REDIS_HOST: ${REDIS_HOST_IP:-redis}
      KAFKA_BROKER: ${KAFKA_BROKER_IP:-kafka:9092}
      RABBITMQ_URL: ${RABBITMQ_URL_IP:-amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASSWORD:-guest}@rabbitmq:5672}
      NODE_ENV: production
    depends_on:
      postgres-transaction:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - stablecoin-network
    restart: unless-stopped

  notification-service:
    build:
      context: ../services/notification-service
      dockerfile: Dockerfile
    container_name: notification-service
    ports:
      - "${NOTIFICATION_SERVICE_PORT:-3004}:3004"
    env_file:
      - .env
      - ../services/notification-service/.env
    environment:
      # Use IP if provided, otherwise use container name
      MONGODB_URI: ${MONGODB_URI_IP:-mongodb://mongodb:27017/${MONGO_DATABASE:-notification_db}}
      RABBITMQ_URL: ${RABBITMQ_URL_IP:-amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASSWORD:-guest}@rabbitmq:5672}
      NODE_ENV: production
    depends_on:
      mongodb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - stablecoin-network
    restart: unless-stopped

  transaction-socket-service:
    build:
      context: ../services/transaction-socket-service
      dockerfile: Dockerfile
    container_name: transaction-socket-service
    ports:
      - "${SOCKET_SERVICE_PORT:-3005}:3005"
    env_file:
      - .env
      - ../services/transaction-socket-service/.env
    environment:
      # Use IP if provided, otherwise use container name
      RABBITMQ_URL: ${RABBITMQ_URL_IP:-amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASSWORD:-guest}@rabbitmq:5672}
      NODE_ENV: production
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - stablecoin-network
    restart: unless-stopped

  # ============================================
  # Frontend Services
  # ============================================

  user-frontend:
    build:
      context: ../frontends/user-frontend
      dockerfile: Dockerfile
    container_name: user-frontend
    ports:
      - "${USER_FRONTEND_PORT:-3006}:3006"
    env_file:
      - .env
      - ../frontends/user-frontend/.env.local
    environment:
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:3001}
      NEXT_PUBLIC_TRANSACTION_API_URL: ${NEXT_PUBLIC_TRANSACTION_API_URL:-http://localhost:3003}
      NEXT_PUBLIC_SOCKET_URL: ${NEXT_PUBLIC_SOCKET_URL:-ws://localhost:3005}
      NEXT_PUBLIC_IS_CAPTCHA: ${NEXT_PUBLIC_IS_CAPTCHA:-false}
      NEXT_PUBLIC_RECAPTCHA_SITE_KEY: ${NEXT_PUBLIC_RECAPTCHA_SITE_KEY:-}
      NEXT_PUBLIC_GRAPHQL_URL: ${NEXT_PUBLIC_GRAPHQL_URL:-http://localhost:3001/graphql}
      NEXT_PUBLIC_TRANSACTION_GRAPHQL_URL: ${NEXT_PUBLIC_TRANSACTION_GRAPHQL_URL:-http://localhost:3003/graphql}
    depends_on:
      - user-service
      - transaction-service
      - transaction-socket-service
    networks:
      - stablecoin-network
    restart: unless-stopped

  admin-frontend:
    build:
      context: ../frontends/admin-frontend
      dockerfile: Dockerfile
    container_name: admin-frontend
    ports:
      - "${ADMIN_FRONTEND_PORT:-3007}:3007"
    env_file:
      - .env
      - ../frontends/admin-frontend/.env.local
    environment:
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:3001}
      NEXT_PUBLIC_TRANSACTION_API_URL: ${NEXT_PUBLIC_TRANSACTION_API_URL:-http://localhost:3003}
      NEXT_PUBLIC_IS_CAPTCHA: ${NEXT_PUBLIC_IS_CAPTCHA:-false}
      NEXT_PUBLIC_RECAPTCHA_SITE_KEY: ${NEXT_PUBLIC_RECAPTCHA_SITE_KEY:-}
      NEXT_PUBLIC_GRAPHQL_URL: ${NEXT_PUBLIC_GRAPHQL_URL:-http://localhost:3001/graphql}
      NEXT_PUBLIC_TRANSACTION_GRAPHQL_URL: ${NEXT_PUBLIC_TRANSACTION_GRAPHQL_URL:-http://localhost:3003/graphql}
    depends_on:
      - user-service
      - transaction-service
    networks:
      - stablecoin-network
    restart: unless-stopped
